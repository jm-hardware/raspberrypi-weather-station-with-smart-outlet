import asyncio
import Adafruit_DHT
from kasa.iot import IotPlug

DHT_SENSOR = Adafruit_DHT.DHT11
DHT_PIN = 4
TEMP_THRESHOLD = 27

PLUG_IP = "192.168.1.100"  # <-- Replace with your plug's actual IP

async def main():
    print(f"Connecting to smart plug at {PLUG_IP}...")
    plug = IotPlug(PLUG_IP)
    await plug.connect(host=192.168.0.7)
    print(f"Connected to plug: {plug.alias} at {plug.host}")

    while True:
        humidity, temperature = Adafruit_DHT.read(DHT_SENSOR, DHT_PIN)
        if temperature is None or humidity is None:
            print("Sensor error – could not read data")
        else:
            print(f"Temp: {temperature:.1f}°C, Humidity: {humidity:.1f}%")
            if temperature > TEMP_THRESHOLD:
                await plug.update()
                if not plug.is_on:
                    print("Temperature high – turning ON plug.")
                    await plug.turn_on()
            else:
                await plug.update()
                if plug.is_on:
                    print("Temperature low – turning OFF plug.")
                    await plug.turn_off()

        await asyncio.sleep(30)

# Use old-style event loop to guarantee printing
loop = asyncio.get_event_loop()
loop.run_until_complete(main())
loop.close()
